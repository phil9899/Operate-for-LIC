#include <Stepper.h>

const int stepsPerRevolution = 2048;
const int motorSpeed = 10; // Motor speed (RPM)
const int stepChunk = 4; // Steps per second

const unsigned long runTime = 10 * 60 * 1000; // 10 minutes

const int buttonPin = 2;
const int motorPins[4] = {8, 9, 10, 11};
Stepper myStepper(stepsPerRevolution, 8, 10, 9, 11); // Pin setting

bool motorRunning = false;
bool lastButtonState = HIGH; // State

unsigned long motorStartTime = 0; // Timestamp
unsigned long lastDebounceTime = 0;
const unsigned long debounceDelay = 40;

void releaseMotor() {
  for (int i = 0; i < 4; i++) {
    digitalWrite(motorPins[i], LOW);
  }
} // Motor setting

void setup() {
  myStepper.setSpeed(motorSpeed);

  pinMode(buttonPin, INPUT_PULLUP);
  for (int i = 0; i < 4; i++) {
    pinMode(motorPins[i], OUTPUT);
  }
}

void loop() {
  bool currentButtonState = digitalRead(buttonPin); // Read the state

  if (currentButtonState != lastButtonState) {
    lastDebounceTime = millis();
  }

  if (millis() - lastDebounceTime > debounceDelay) { // Check the state
    if (lastButtonState == HIGH && currentButtonState == LOW) {
      if (!motorRunning) {
        motorRunning = true;
        motorStartTime = millis(); // Record
      } else {
        motorRunning = false;
        releaseMotor();
      }
    }
  }

  lastButtonState = currentButtonState; // Record state

  if (motorRunning) {
    if (millis() - motorStartTime >= runTime) {
      motorRunning = false; // Timeout stop
      releaseMotor();
    } else {
      myStepper.step(stepChunk);
    }
  }
}
